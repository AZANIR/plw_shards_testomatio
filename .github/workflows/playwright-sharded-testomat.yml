name: Playwright Sharded with Testomat.io

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch: # Allows manual trigger

jobs:
  playwright-tests:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false # Continue running other shards even if one fails
      matrix:
        shardIndex: [1, 2, 3] # Number of shards - adjust based on your test suite size
        shardTotal: [3]

    env:
      # --- Testomat.io environment variables ---
      TESTOMATIO: ${{ secrets.TESTOMATIO }} # Your Testomat.io API key
      TESTOMATIO_URL: ${{ secrets.TESTOMATIO_URL }} # Optional: Project ID if you use it
      TESTOMATIO_RUN: "Playwright Sharded CI Run - ${{ github.run_id }}"
      TESTOMATIO_SHARED_RUN: "1" # Enable shared run for sharding

      # Optional: Link run to CI build / PR
      CI_BUILD_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      CI_COMMIT_SHA: ${{ github.sha }}
      CI_COMMIT_REF: ${{ github.ref }}

      # --- Node / Playwright general envs ---
      NODE_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Echo shard info
        run: |
          echo "üöÄ Running shard ${{ matrix.shardIndex }} of ${{ matrix.shardTotal }}"
          echo "üìä Total shards: ${{ matrix.shardTotal }}"
          echo "üîë Testomat.io API key configured: ${{ secrets.TESTOMATIO != '' }}"

      - name: Run Playwright tests (sharded)
        timeout-minutes: 30
        run: |
          npx playwright test \
            --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} || true
        continue-on-error: true

      # Upload blob report for merging
      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shardIndex }}
          path: blob-report/
          if-no-files-found: ignore
          retention-days: 1

      # Upload JUnit report for Testomat.io
      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report-${{ matrix.shardIndex }}
          path: test-results/junit.xml
          if-no-files-found: ignore
          retention-days: 1

      # Optional: Upload Playwright HTML report artifacts
      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-shard-${{ matrix.shardIndex }}
          path: playwright-report/
          if-no-files-found: ignore
          retention-days: 7

      # Optional: Upload test results as JSON
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-shard-${{ matrix.shardIndex }}
          path: test-results/
          if-no-files-found: ignore
          retention-days: 7

  merge-and-upload:
    if: ${{ !cancelled() }}
    needs: [playwright-tests]
    runs-on: ubuntu-latest

    env:
      TESTOMATIO: ${{ secrets.TESTOMATIO }}
      TESTOMATIO_URL: ${{ secrets.TESTOMATIO_URL }}
      # Don't set TESTOMATIO_RUN - let xml command create run automatically

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download blob reports
        uses: actions/download-artifact@v5
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Download JUnit reports
        uses: actions/download-artifact@v5
        with:
          path: all-junit-reports
          pattern: junit-report-*
          merge-multiple: true

      - name: Merge blob reports to JUnit
        run: |
          if [ -d "all-blob-reports" ] && [ "$(ls -A all-blob-reports)" ]; then
            echo "Merging blob reports to JUnit..."
            npx playwright merge-reports --config=merge-junit.config.ts --reporter=junit ./all-blob-reports || echo "Merge failed"
            # Check if merged file was created
            if [ -f "merged-junit.xml" ]; then
              echo "‚úÖ Merged JUnit file created: merged-junit.xml"
              ls -lh merged-junit.xml
            else
              echo "‚ö†Ô∏è Merged JUnit file not found, checking test-results directory..."
              ls -la test-results/ || true
            fi
          else
            echo "No blob reports found"
          fi

      - name: Create Testomat.io run
        if: always()
        timeout-minutes: 2
        run: |
          echo "Creating Testomat.io run..."
          # Create run first - this will return run ID or use TESTOMATIO_RUN
          npx @testomatio/reporter start --kind automated || echo "Run creation failed or already exists"
        continue-on-error: true

      - name: Upload merged results to Testomat.io
        if: always()
        timeout-minutes: 5
        run: |
          # Check for merged JUnit file in different locations
          JUNIT_FILE=""
          if [ -f "merged-junit.xml" ]; then
            JUNIT_FILE="merged-junit.xml"
            echo "‚úÖ Found merged JUnit file: merged-junit.xml"
          elif [ -f "test-results/junit.xml" ]; then
            JUNIT_FILE="test-results/junit.xml"
            echo "‚úÖ Found JUnit file in test-results: test-results/junit.xml"
          elif [ -d "all-junit-reports" ] && [ "$(ls -A all-junit-reports/*.xml 2>/dev/null)" ]; then
            JUNIT_FILE="$(ls all-junit-reports/*.xml | head -1)"
            echo "‚úÖ Found JUnit file in artifacts: $JUNIT_FILE"
          fi
          
          if [ -n "$JUNIT_FILE" ] && [ -f "$JUNIT_FILE" ]; then
            echo "Uploading JUnit report to Testomat.io: $JUNIT_FILE"
            echo "File size: $(ls -lh "$JUNIT_FILE" | awk '{print $5}')"
            # Don't set TESTOMATIO_RUN - let it create run automatically
            unset TESTOMATIO_RUN
            npx @testomatio/reporter xml "$JUNIT_FILE" || echo "Upload failed"
          else
            echo "‚ùå No JUnit reports found for upload"
            echo "Checking directories..."
            ls -la . || true
            ls -la test-results/ || true
            ls -la all-junit-reports/ || true
          fi
        continue-on-error: true

      - name: Generate merged HTML report
        if: always()
        run: |
          if [ -d "all-blob-reports" ] && [ "$(ls -A all-blob-reports)" ]; then
            echo "Generating merged HTML report..."
            npx playwright merge-reports --reporter=html ./all-blob-reports || echo "HTML report generation failed"
          fi

      - name: Upload merged HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: merged-html-report
          path: playwright-report/
          if-no-files-found: ignore
          retention-days: 14
